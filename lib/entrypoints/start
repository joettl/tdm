set -e
. "$LIBDIR"/mkconfig
INSTANCE="$2"
if [ -z "$INSTANCE" ]; then
  echo "usage: tdm start INSTANCE"
  exit 1
fi
PFX="$INSTANCE_PREFIX"/$INSTANCE
cd "$PFX"

tdm stop "$INSTANCE" || true

PORT=$(grep rpc-port config/settings.json | awk '{print $2}' | tr -d ',')
PUBIP=$(ip route get 8.8.8.8 | awk '{print $7}' | tr -d ' \n')

mkconfig

stunnel -o $PFX/config/.stunnel.log -P $PFX/config/.stunnel.pid -p $PFX/config/stunnel.pem -d $PUBIP:$PORT -r $PORT

exec transmission-daemon -g $PFX/config
